# ERP System Nginx Configuration
# 反向代理 + 负载均衡 + 限流

# 限流配置
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=stock_limit:10m rate=500r/s;
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=10r/s;

# 上游服务定义
upstream item_service {
    server item-service:8001;
    keepalive 32;
}

upstream user_service {
    server user-service:8001;
    keepalive 32;
}

upstream stock_service {
    server stock-service:8002;
    keepalive 64;
}

upstream purchase_service {
    server purchase-service:8003;
    keepalive 16;
}

upstream production_service {
    server production-service:8004;
    keepalive 16;
}

upstream job_service {
    server job-service:8005;
    keepalive 16;
}

upstream cost_service {
    server cost-service:8006;
    keepalive 16;
}

upstream order_service {
    server order-service:8007;
    keepalive 32;
}

upstream member_service {
    server member-service:8008;
    keepalive 16;
}

upstream promo_service {
    server promo-service:8009;
    keepalive 16;
}

server {
    listen 80;
    server_name localhost;

    # 字符集
    charset utf-8;

    # 日志配置
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # CORS 配置
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers 'Authorization, Content-Type, X-Requested-With' always;
    add_header Access-Control-Max-Age 86400 always;

    # 预检请求处理
    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # ==================== 白名单路由（无需认证）====================
    
    # API 文档（Swagger UI）- 无需认证
    location /user/docs {
        proxy_pass http://user_service;
        proxy_set_header Host $host;
    }
    location /user/openapi.json {
        proxy_pass http://user_service;
        proxy_set_header Host $host;
    }
    location /item/docs {
        proxy_pass http://item_service;
        proxy_set_header Host $host;
    }
    location /item/openapi.json {
        proxy_pass http://item_service;
        proxy_set_header Host $host;
    }
    location /stock/docs {
        proxy_pass http://stock_service;
        proxy_set_header Host $host;
    }
    location /stock/openapi.json {
        proxy_pass http://stock_service;
        proxy_set_header Host $host;
    }
    location /order/docs {
        proxy_pass http://order_service;
        proxy_set_header Host $host;
    }
    location /order/openapi.json {
        proxy_pass http://order_service;
        proxy_set_header Host $host;
    }
    location /member/docs {
        proxy_pass http://member_service;
        proxy_set_header Host $host;
    }
    location /member/openapi.json {
        proxy_pass http://member_service;
        proxy_set_header Host $host;
    }
    
    # 用户登录
    location /user/login {
        limit_req zone=login_limit burst=5 nodelay;
        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 用户注册
    location /user/register {
        limit_req zone=login_limit burst=5 nodelay;
        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 健康检查端点（无需认证）
    location = /user/health {
        proxy_pass http://user_service/user/health;
        proxy_set_header Host $host;
    }
    location = /item/health {
        proxy_pass http://item_service/item/health;
        proxy_set_header Host $host;
    }
    location = /stock/health {
        proxy_pass http://stock_service/stock/health;
        proxy_set_header Host $host;
    }
    location = /order/health {
        proxy_pass http://order_service/order/health;
        proxy_set_header Host $host;
    }
    location = /member/health {
        proxy_pass http://member_service/member/health;
        proxy_set_header Host $host;
    }
    location = /purchase/health {
        proxy_pass http://purchase_service/purchase/health;
        proxy_set_header Host $host;
    }
    location = /production/health {
        proxy_pass http://production_service/production/health;
        proxy_set_header Host $host;
    }
    location = /job/health {
        proxy_pass http://job_service/job/health;
        proxy_set_header Host $host;
    }
    location = /cost/health {
        proxy_pass http://cost_service/cost/health;
        proxy_set_header Host $host;
    }
    location = /promo/health {
        proxy_pass http://promo_service/promo/health;
        proxy_set_header Host $host;
    }

    # ==================== 需要认证的路由 ====================

    # 商品中心
    location /item/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        # 认证验证
        auth_request /auth/verify;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $username $upstream_http_x_username;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        
        # 传递用户信息到后端
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-Username $username;
        proxy_set_header X-User-Roles $user_roles;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        proxy_pass http://item_service;
    }

    # 用户中心（认证相关）
    location /user/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        auth_request /auth/verify;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $username $upstream_http_x_username;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-Username $username;
        proxy_set_header X-User-Roles $user_roles;
        proxy_set_header Host $host;
        
        proxy_pass http://user_service;
    }

    # 库存中心（高并发）
    location /stock/ {
        limit_req zone=stock_limit burst=50 nodelay;
        
        auth_request /auth/verify;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $username $upstream_http_x_username;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-Username $username;
        proxy_set_header X-User-Roles $user_roles;
        proxy_set_header Host $host;
        
        proxy_pass http://stock_service;
    }

    # 采购中心
    location /po/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        auth_request /auth/verify;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $username $upstream_http_x_username;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-Username $username;
        proxy_set_header X-User-Roles $user_roles;
        proxy_set_header Host $host;
        
        proxy_pass http://purchase_service;
    }

    # 生产中心
    location /mo/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        auth_request /auth/verify;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $username $upstream_http_x_username;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-Username $username;
        proxy_set_header X-User-Roles $user_roles;
        proxy_set_header Host $host;
        
        proxy_pass http://production_service;
    }

    # 报工中心
    location /job/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        auth_request /auth/verify;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $username $upstream_http_x_username;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-Username $username;
        proxy_set_header X-User-Roles $user_roles;
        proxy_set_header Host $host;
        
        proxy_pass http://job_service;
    }

    # 成本中心
    location /cost/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        auth_request /auth/verify;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $username $upstream_http_x_username;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-Username $username;
        proxy_set_header X-User-Roles $user_roles;
        proxy_set_header Host $host;
        
        proxy_pass http://cost_service;
    }

    # 订单中心
    location /order/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        auth_request /auth/verify;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $username $upstream_http_x_username;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-Username $username;
        proxy_set_header X-User-Roles $user_roles;
        proxy_set_header Host $host;
        
        proxy_pass http://order_service;
    }

    # 会员中心
    location /member/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        auth_request /auth/verify;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $username $upstream_http_x_username;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-Username $username;
        proxy_set_header X-User-Roles $user_roles;
        proxy_set_header Host $host;
        
        proxy_pass http://member_service;
    }

    # 促销中心
    location /promo/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        auth_request /auth/verify;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $username $upstream_http_x_username;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-Username $username;
        proxy_set_header X-User-Roles $user_roles;
        proxy_set_header Host $host;
        
        proxy_pass http://promo_service;
    }

    # ==================== 内部认证端点 ====================
    
    location = /auth/verify {
        internal;
        proxy_pass http://user_service/user/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header Authorization $http_authorization;
    }

    # 错误页面
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
